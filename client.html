<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DocWave Realtime Test (Awareness)</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        background: #fafafa;
        font-family: system-ui, sans-serif;
      }
      h2 {
        margin: 0;
        padding: 10px;
        background: #0078ff;
        color: white;
        font-size: 18px;
      }
      #container {
        position: relative;
        padding: 10px;
      }
      #editor {
        width: 100%;
        height: 400px;
        font-size: 16px;
        border: 2px solid #ccc;
        border-radius: 8px;
        padding: 8px;
        resize: none;
      }
      .cursor {
        position: absolute;
        width: 2px;
        height: 1.2em;
        animation: blink 1s step-end infinite;
      }
      @keyframes blink {
        50% { opacity: 0; }
      }
      .label {
        position: absolute;
        font-size: 12px;
        padding: 2px 5px;
        border-radius: 4px;
        color: #fff;
        transform: translateY(-100%);
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <h2>ðŸ§  DocWave Yjs Realtime Test (Awareness)</h2>
    <div id="container">
      <textarea id="editor" placeholder="Start typing..."></textarea>
    </div>

    <script type="module">
      import { io } from "https://cdn.socket.io/4.7.5/socket.io.esm.min.js";
      import * as Y from "https://cdn.jsdelivr.net/npm/yjs@13.6.14/+esm";

      // ======== CONFIG ========
      const SERVER = "http://192.168.1.98:3000"; // âš ï¸ Ä‘á»•i sang IP cá»§a báº¡n náº¿u test LAN
      const DOC_ID = "demo-doc-1";

      // ======== SETUP ========
      const socket = io(SERVER, { transports: ["websocket"] });
      const doc = new Y.Doc();
      const text = doc.getText("content");
      const editor = document.getElementById("editor");
      const container = document.getElementById("container");

      const username = prompt("Enter your name:", "User" + Math.floor(Math.random() * 100));
      const color = `hsl(${Math.random() * 360}, 90%, 60%)`;

      // join room
      socket.emit("join", { docId: DOC_ID });

      socket.on("sync", (buf) => Y.applyUpdate(doc, new Uint8Array(buf)));
      socket.on("update", (buf) => Y.applyUpdate(doc, new Uint8Array(buf)));

      // debounce send updates
      let pending = [];
      let timer;
      doc.on("update", (u) => {
        pending.push(u);
        clearTimeout(timer);
        timer = setTimeout(() => {
          const merged = Y.mergeUpdates(pending);
          pending = [];
          socket.emit("update", merged);
        }, 50);
      });

      // ======== Awareness (cursor + name + color) ========
      let cursorElems = new Map();

      // gá»­i awareness má»—i khi di chuá»™t / nháº­p text
      function sendAwareness() {
        const selectionStart = editor.selectionStart;
        const rect = getCaretCoordinates(editor, selectionStart);
        socket.emit("awareness", {
          name: username,
          color,
          cursor: { x: rect.left, y: rect.top },
        });
      }

      editor.addEventListener("mousemove", sendAwareness);
      editor.addEventListener("keyup", sendAwareness);
      editor.addEventListener("click", sendAwareness);

      // nháº­n awareness tá»« ngÆ°á»i khÃ¡c
      socket.on("awareness", (arr) => {
        arr.forEach(({ clientId, payload }) => {
          if (!payload) {
            // user disconnected
            const el = cursorElems.get(clientId);
            if (el) el.remove();
            cursorElems.delete(clientId);
            return;
          }

          // cáº­p nháº­t hoáº·c táº¡o má»›i
          let el = cursorElems.get(clientId);
          if (!el) {
            el = document.createElement("div");
            el.classList.add("cursor");
            el.style.background = payload.color;
            const label = document.createElement("div");
            label.classList.add("label");
            label.style.background = payload.color;
            label.textContent = payload.name;
            el.appendChild(label);
            container.appendChild(el);
            cursorElems.set(clientId, el);
          }
          el.style.left = payload.cursor.x + "px";
          el.style.top = payload.cursor.y + "px";
        });
      });

      // ======== Text binding ========
      text.observe(() => {
        const curr = text.toString();
        if (editor.value !== curr) editor.value = curr;
      });
      editor.addEventListener("input", () => {
        const curr = text.toString();
        const next = editor.value;
        text.delete(0, curr.length);
        text.insert(0, next);
      });

      // ======== Helper: getCaretCoordinates ========
      // ráº¥t Ä‘Æ¡n giáº£n, Æ°á»›c lÆ°á»£ng vá»‹ trÃ­ caret trong textarea
      function getCaretCoordinates(textarea, pos) {
        const div = document.createElement("div");
        const style = getComputedStyle(textarea);
        for (const prop of style) div.style[prop] = style[prop];
        div.style.position = "absolute";
        div.style.visibility = "hidden";
        div.textContent = textarea.value.substring(0, pos);
        const span = document.createElement("span");
        span.textContent = textarea.value.substring(pos) || ".";
        div.appendChild(span);
        document.body.appendChild(div);
        const { offsetLeft: left, offsetTop: top } = span;
        document.body.removeChild(div);
        const rect = textarea.getBoundingClientRect();
        return { left: rect.left + left, top: rect.top + top - textarea.scrollTop };
      }
    </script>
  </body>
</html>
